# ZenPub 缓存功能指南

## 功能概述

ZenPub 现在支持高级缓存功能，可以让应用记住用户上次打开的文件和浏览位置，并在下次启动时自动恢复到该状态。

## 实现的技术

### 1. Service Worker 离线缓存
- 位置：`/public/sw.js`
- 功能：
  - 预缓存静态资源（HTML、CSS、JS、图片等）
  - 拦截网络请求，优先使用缓存
  - 支持动态缓存新加载的资源
  - 自动清理过期缓存

### 2. IndexedDB 状态存储
- 位置：`/services/cacheService.ts`
- 功能：
  - 存储用户状态（滚动位置、打开的章节、布局设置等）
  - 保存项目数据（章节内容、元数据）
  - 记录文件访问历史
  - 自动清理旧历史记录

### 3. React Hook 集成
- 位置：`/hooks/useAppCache.ts`
- 功能：
  - 自动保存和恢复应用状态
  - 监听滚动位置变化
  - 页面关闭前自动保存
  - 提供手动清除缓存功能

## 用户界面变化

### 1. 状态指示器
- 在应用顶部添加了状态指示器
- 绿色闪烁点：正在恢复状态
- 蓝色点：状态已保存

### 2. 缓存管理
- 在设置菜单中添加了"清理缓存"按钮
- 可以清除所有缓存数据并重置应用

## 技术细节

### 缓存策略
1. **静态资源**：使用 Service Worker 缓存，优先从缓存加载
2. **用户状态**：使用 IndexedDB 存储，包括：
   - 最后打开的章节ID
   - 编辑器和预览区域的滚动位置
   - 视图模式（编辑/预览/分屏）
   - 侧边栏和备注面板状态
   - 主题设置
   - 布局宽度设置
   - 预览配置

3. **项目数据**：使用 IndexedDB 存储，包括：
   - 书籍元数据
   - 所有章节内容
   - 最后修改时间

### 自动保存时机
- 状态变化时（2秒防抖）
- 滚动位置变化时
- 页面关闭前
- 页面隐藏时

### 性能优化
- 使用防抖机制避免频繁保存
- 异步操作不阻塞UI
- 自动清理过期数据
- 增量更新而非全量覆盖

## 使用指南

1. **自动恢复**：应用启动时会自动恢复上次的状态
2. **手动清理**：在设置中点击"清理缓存"可以清除所有缓存
3. **状态指示**：顶部状态指示器显示当前状态
4. **离线使用**：一旦资源被缓存，即使离线也可以继续使用

## 开发者测试

可以在浏览器控制台中加载 `/test-cache.js` 文件，然后运行 `testCache()` 函数来验证缓存功能是否正常工作。

## 注意事项

1. 首次使用时没有缓存数据，需要用户操作后才会保存
2. 清理缓存会删除所有保存的状态和数据
3. 浏览器隐私模式下可能无法使用 IndexedDB
4. 离线模式下只能访问已缓存的资源

## 兼容性

- 支持所有现代浏览器（Chrome、Firefox、Safari、Edge）
- 需要 Service Worker 和 IndexedDB 支持
- 移动端和桌面端均可正常使用